<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASD English Department Library</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,600;0,700;1,600&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --navy:    #1a2e4a;
      --navy-d:  #0f1e30;
      --navy-l:  #243a5e;
      --gold:    #c9a43b;
      --gold-l:  #e8c96a;
      --cream:   #f8f6f1;
      --surface: #ffffff;
      --border:  #ddd8ce;
      --text:    #1c2b3a;
      --muted:   #7a8898;
      --danger:  #c0392b;
      --success: #27794e;
      --warning: #a07800;
      --radius:  8px;
      --shadow:  0 2px 12px rgba(26,46,74,0.10);
      --shadow-lg: 0 8px 32px rgba(26,46,74,0.18);
      --t: 150ms ease;
    }
    html { font-size: 15px; }
    body { font-family: 'DM Sans', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }

    /* HEADER */
    header { background: linear-gradient(135deg, var(--navy-d) 0%, var(--navy) 100%); color: #fff; padding: 0 1.5rem; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 16px rgba(0,0,0,0.25); }
    .header-inner { max-width: 1300px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0; }
    .header-brand .eyebrow { font-size: 0.68rem; letter-spacing: 0.18em; text-transform: uppercase; color: var(--gold-l); font-weight: 500; }
    .header-brand h1 { font-family: 'Playfair Display', serif; font-size: 1.35rem; font-weight: 700; color: #fff; }
    .header-status { font-size: 0.78rem; color: rgba(255,255,255,0.55); display: flex; align-items: center; gap: 0.4rem; }
    .status-dot { width: 7px; height: 7px; border-radius: 50%; background: #6dce8e; display: inline-block; }
    .status-dot.loading { background: var(--gold-l); animation: pulse 1s infinite; }
    .status-dot.error { background: #e07070; }
    @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.4} }

    /* TABS */
    .tabs-bar { background: var(--navy-d); border-top: 1px solid rgba(255,255,255,0.07); }
    .tabs-inner { max-width: 1300px; margin: 0 auto; padding: 0 1.5rem; display: flex; overflow-x: auto; scrollbar-width: none; }
    .tabs-inner::-webkit-scrollbar { display: none; }
    .tab-btn { background: none; border: none; color: rgba(255,255,255,0.55); font-family: 'DM Sans', sans-serif; font-size: 0.82rem; font-weight: 500; padding: 0.65rem 1rem; cursor: pointer; white-space: nowrap; border-bottom: 3px solid transparent; transition: color var(--t), border-color var(--t); }
    .tab-btn:hover { color: rgba(255,255,255,0.85); }
    .tab-btn.active { color: var(--gold-l); border-bottom-color: var(--gold); }
    .tab-count { display: inline-block; background: rgba(255,255,255,0.12); color: rgba(255,255,255,0.7); border-radius: 20px; font-size: 0.68rem; padding: 0.1rem 0.45rem; margin-left: 0.3rem; font-weight: 600; }
    .tab-btn.active .tab-count { background: var(--gold); color: var(--navy-d); }

    /* MAIN */
    main { max-width: 1300px; margin: 0 auto; padding: 1.5rem; width: 100%; flex: 1; }

    /* TOOLBAR */
    .toolbar { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1.25rem; }
    .search-wrap { position: relative; flex: 1; min-width: 200px; }
    .search-wrap svg { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--muted); pointer-events: none; }
    .search-input { width: 100%; padding: 0.55rem 0.75rem 0.55rem 2.25rem; border: 1.5px solid var(--border); border-radius: var(--radius); font-family: 'DM Sans', sans-serif; font-size: 0.88rem; background: var(--surface); color: var(--text); transition: border-color var(--t), box-shadow var(--t); }
    .search-input:focus { outline: none; border-color: var(--navy-l); box-shadow: 0 0 0 3px rgba(26,46,74,0.1); }

    /* BUTTONS */
    .btn { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.55rem 1rem; border-radius: var(--radius); font-family: 'DM Sans', sans-serif; font-size: 0.85rem; font-weight: 500; cursor: pointer; border: 1.5px solid transparent; transition: all var(--t); white-space: nowrap; }
    .btn-primary { background: var(--navy); color: #fff; border-color: var(--navy); }
    .btn-primary:hover { background: var(--navy-l); }
    .btn-secondary { background: var(--surface); color: var(--navy); border-color: var(--border); }
    .btn-secondary:hover { background: var(--cream); border-color: var(--navy); }
    .btn-ghost { background: none; color: var(--muted); border-color: transparent; padding: 0.4rem 0.6rem; }
    .btn-ghost:hover { color: var(--text); background: rgba(0,0,0,0.05); }
    .btn-danger { background: var(--danger); color: #fff; border-color: var(--danger); }
    .btn-danger:hover { background: #a93226; }
    .btn-gold { background: none; color: var(--gold); border-color: var(--gold); }
    .btn-gold:hover, .btn-gold.active { background: var(--gold); color: #fff; }
    .btn-teal { background: none; color: var(--success); border-color: var(--success); }
    .btn-teal:hover { background: var(--success); color: #fff; }
    .btn:disabled { opacity: 0.45; cursor: not-allowed; }

    /* ROOM HEADER */
    .room-header { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem 1.25rem; margin-bottom: 1.25rem; display: flex; align-items: flex-start; justify-content: space-between; flex-wrap: wrap; gap: 0.75rem; box-shadow: var(--shadow); }
    .room-header-left h2 { font-family: 'Playfair Display', serif; font-size: 1.15rem; color: var(--navy); }
    .teacher-display { font-size: 0.83rem; color: var(--muted); margin-top: 0.2rem; }
    .teacher-edit-wrap { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.35rem; }
    .inline-input { padding: 0.35rem 0.6rem; border: 1.5px solid var(--border); border-radius: 5px; font-family: 'DM Sans', sans-serif; font-size: 0.85rem; color: var(--text); min-width: 180px; }
    .inline-input:focus { outline: none; border-color: var(--navy-l); }
    .room-actions { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }

    /* MODE PILLS */
    .mode-indicator { display: inline-flex; align-items: center; gap: 0.4rem; background: #fff8e0; border: 1px solid #e8c96a; border-radius: 20px; padding: 0.3rem 0.75rem; font-size: 0.75rem; font-weight: 600; color: #7a5800; }
    .mode-indicator.recount { background: #e8f5ee; border-color: #6dce8e; color: #1a5c35; }

    /* TABLE */
    .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); }
    table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    thead { background: var(--navy); color: #fff; }
    thead th { padding: 0.7rem 1rem; text-align: left; font-weight: 500; font-size: 0.78rem; letter-spacing: 0.06em; text-transform: uppercase; white-space: nowrap; }
    thead th.sortable { cursor: pointer; user-select: none; }
    thead th.sortable:hover { background: var(--navy-l); }
    thead th.sorted .sort-icon { color: var(--gold-l); }
    .sort-icon { margin-left: 0.3rem; opacity: 0.5; }
    thead th.sorted .sort-icon { opacity: 1; }
    tbody tr { border-bottom: 1px solid var(--border); transition: background var(--t); }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: rgba(26,46,74,0.03); }
    tbody td { padding: 0.65rem 1rem; vertical-align: middle; }
    .td-title { font-weight: 500; }
    .td-author { color: var(--muted); }
    .td-qty { text-align: center; }
    .td-locations { font-size: 0.78rem; color: var(--muted); }
    .qty-badge { display: inline-flex; align-items: center; justify-content: center; background: var(--cream); border: 1px solid var(--border); border-radius: 20px; padding: 0.15rem 0.6rem; font-size: 0.8rem; font-weight: 600; color: var(--navy); min-width: 36px; }
    .qty-badge.changed { background: #fff8e0; border-color: var(--gold); color: #7a5800; }
    .actions-cell { display: flex; gap: 0.3rem; align-items: center; justify-content: flex-end; }

    /* QTY CONTROLS */
    .qty-control { display: flex; align-items: center; gap: 0.35rem; }
    .qty-btn { width: 26px; height: 26px; border-radius: 5px; border: 1.5px solid var(--border); background: var(--surface); cursor: pointer; font-size: 1rem; line-height: 1; color: var(--navy); display: flex; align-items: center; justify-content: center; transition: all var(--t); }
    .qty-btn:hover { background: var(--navy); color: #fff; border-color: var(--navy); }
    .qty-input { width: 56px; text-align: center; padding: 0.25rem 0.3rem; border: 1.5px solid var(--border); border-radius: 5px; font-family: 'DM Sans', sans-serif; font-size: 0.88rem; font-weight: 600; }
    .qty-input:focus { outline: none; border-color: var(--navy-l); }
    .qty-input.dirty { border-color: var(--gold); background: #fff8e0; }

    /* RECOUNT INPUT */
    .recount-input { width: 70px; text-align: center; padding: 0.3rem 0.4rem; border: 2px solid var(--success); border-radius: 5px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem; font-weight: 600; background: #f0faf5; color: var(--navy); }
    .recount-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(39,121,78,0.15); }
    .recount-prev { font-size: 0.72rem; color: var(--muted); margin-left: 0.3rem; }

    /* EMPTY STATE */
    .empty-state { padding: 3.5rem 1rem; text-align: center; color: var(--muted); }
    .empty-state h3 { font-family: 'Playfair Display', serif; font-size: 1.1rem; color: var(--navy); margin-bottom: 0.35rem; }
    .empty-state p { font-size: 0.9rem; }

    /* LOADING */
    .loading-overlay { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4rem 1rem; gap: 1rem; color: var(--muted); font-size: 0.9rem; }
    .spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--navy); border-radius: 50%; animation: spin 0.75s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* MODALS */
    .modal-overlay { position: fixed; inset: 0; background: rgba(10,20,35,0.55); z-index: 300; display: flex; align-items: center; justify-content: center; padding: 1rem; opacity: 0; pointer-events: none; transition: opacity 200ms ease; }
    .modal-overlay.visible { opacity: 1; pointer-events: all; }
    .modal { background: var(--surface); border-radius: 12px; box-shadow: var(--shadow-lg); width: 100%; max-width: 480px; max-height: 90vh; overflow-y: auto; transform: translateY(16px); transition: transform 200ms ease; }
    .modal-overlay.visible .modal { transform: translateY(0); }
    .modal.wide { max-width: 600px; }
    .modal.tall { max-width: 560px; }
    .modal-header { padding: 1.25rem 1.5rem 0; display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem; }
    .modal-header h3 { font-family: 'Playfair Display', serif; font-size: 1.15rem; color: var(--navy); }
    .modal-header .modal-subtitle { font-size: 0.78rem; color: var(--muted); margin-top: 0.2rem; }
    .modal-body { padding: 1rem 1.5rem; }
    .modal-footer { padding: 0.75rem 1.5rem 1.25rem; display: flex; gap: 0.6rem; justify-content: flex-end; }
    .modal-close { background: none; border: none; cursor: pointer; color: var(--muted); padding: 0.1rem; font-size: 1.25rem; transition: color var(--t); }
    .modal-close:hover { color: var(--text); }

    /* FORM */
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-size: 0.8rem; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.35rem; }
    .form-input, .form-select { width: 100%; padding: 0.55rem 0.75rem; border: 1.5px solid var(--border); border-radius: var(--radius); font-family: 'DM Sans', sans-serif; font-size: 0.88rem; color: var(--text); background: var(--surface); transition: border-color var(--t); }
    .form-input:focus, .form-select:focus { outline: none; border-color: var(--navy-l); box-shadow: 0 0 0 3px rgba(26,46,74,0.08); }
    .form-input.readonly { background: var(--cream); color: var(--muted); cursor: not-allowed; }
    .form-hint { font-size: 0.75rem; color: var(--muted); margin-top: 0.3rem; }
    .form-warning { background: #fff8e1; border: 1px solid #f0c040; border-radius: 6px; padding: 0.6rem 0.75rem; font-size: 0.8rem; color: #8a6200; margin-top: 0.4rem; }
    .form-info { background: #e8f4fb; border: 1px solid #9dd0ed; border-radius: 6px; padding: 0.6rem 0.75rem; font-size: 0.8rem; color: #1a5070; margin-top: 0.4rem; }
    .divider { border: none; border-top: 1px solid var(--border); margin: 0.75rem 0; }

    /* AUTOCOMPLETE */
    .autocomplete-wrap { position: relative; }
    .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: var(--surface); border: 1.5px solid var(--navy-l); border-top: none; border-radius: 0 0 var(--radius) var(--radius); max-height: 220px; overflow-y: auto; z-index: 50; box-shadow: var(--shadow); display: none; }
    .autocomplete-list.open { display: block; }
    .autocomplete-item { padding: 0.55rem 0.75rem; cursor: pointer; font-size: 0.85rem; border-bottom: 1px solid var(--border); transition: background var(--t); }
    .autocomplete-item:last-child { border-bottom: none; }
    .autocomplete-item:hover, .autocomplete-item.highlighted { background: var(--cream); }
    .autocomplete-item .item-title { font-weight: 500; }
    .autocomplete-item .item-author { color: var(--muted); font-size: 0.78rem; }
    .autocomplete-item.create-new { color: var(--navy); font-weight: 500; font-style: italic; }

    /* RECOUNT TABLE */
    .recount-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .recount-table th { padding: 0.5rem 0.75rem; text-align: left; font-size: 0.72rem; letter-spacing: 0.06em; text-transform: uppercase; color: var(--muted); border-bottom: 2px solid var(--border); }
    .recount-table td { padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
    .recount-table tr:last-child td { border-bottom: none; }
    .recount-table tr:hover td { background: rgba(26,46,74,0.02); }
    .recount-note { font-size: 0.78rem; color: var(--muted); background: #f0faf5; border: 1px solid #c0e8d0; border-radius: 6px; padding: 0.6rem 0.75rem; margin-bottom: 0.75rem; }

    /* TOAST */
    #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 500; display: flex; flex-direction: column; gap: 0.5rem; }
    .toast { background: var(--navy-d); color: #fff; padding: 0.65rem 1rem; border-radius: var(--radius); font-size: 0.85rem; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 0.5rem; max-width: 320px; animation: slideIn 250ms ease; }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }
    .toast.warning { background: var(--warning); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* CONFIRM */
    .confirm-modal { max-width: 380px; }
    .confirm-body { padding: 1.25rem 1.5rem; color: var(--text); font-size: 0.9rem; line-height: 1.6; }

    /* CONFIG BANNER */
    .config-banner { background: #fff4e0; border: 1px solid #f0c040; border-radius: var(--radius); padding: 1rem 1.25rem; margin-bottom: 1.5rem; font-size: 0.88rem; color: #6b4f00; }
    .config-banner strong { display: block; margin-bottom: 0.3rem; }
    .config-banner code { background: rgba(0,0,0,0.08); padding: 0.1rem 0.35rem; border-radius: 3px; font-size: 0.82rem; }

    /* CSV */
    .csv-preview { background: var(--cream); border: 1px solid var(--border); border-radius: 6px; padding: 0.75rem; font-size: 0.78rem; font-family: monospace; max-height: 200px; overflow-y: auto; margin-top: 0.5rem; }
    .import-stats { font-size: 0.85rem; color: var(--muted); margin-top: 0.5rem; background: #eef4fb; border-radius: 6px; padding: 0.5rem 0.75rem; }
    .csv-error-item { color: var(--danger); font-size: 0.78rem; padding: 0.2rem 0; }

    @media (max-width: 640px) {
      main { padding: 1rem; }
      .btn { font-size: 0.8rem; padding: 0.5rem 0.75rem; }
    }
  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="header-brand">
      <span class="eyebrow">American School of Dhahran</span>
      <h1>English Department Library</h1>
    </div>
    <div class="header-status">
      <span class="status-dot" id="status-dot"></span>
      <span id="status-text">Loading‚Ä¶</span>
    </div>
  </div>
</header>

<div class="tabs-bar">
  <div class="tabs-inner" id="tabs-container">
    <button class="tab-btn active" data-tab="all">All Books <span class="tab-count" id="count-all">‚Äî</span></button>
    <button class="tab-btn" data-tab="A-2-3">A-2-3 <span class="tab-count" id="count-A-2-3">‚Äî</span></button>
    <button class="tab-btn" data-tab="A-2-4">A-2-4 <span class="tab-count" id="count-A-2-4">‚Äî</span></button>
    <button class="tab-btn" data-tab="A-2-5">A-2-5 <span class="tab-count" id="count-A-2-5">‚Äî</span></button>
    <button class="tab-btn" data-tab="A-2-6">A-2-6 <span class="tab-count" id="count-A-2-6">‚Äî</span></button>
    <button class="tab-btn" data-tab="A-2-7">A-2-7 <span class="tab-count" id="count-A-2-7">‚Äî</span></button>
    <button class="tab-btn" data-tab="A-2-8">A-2-8 <span class="tab-count" id="count-A-2-8">‚Äî</span></button>
    <button class="tab-btn" data-tab="A-2-9">A-2-9 <span class="tab-count" id="count-A-2-9">‚Äî</span></button>
    <button class="tab-btn" data-tab="A-2-10">A-2-10 <span class="tab-count" id="count-A-2-10">‚Äî</span></button>
  </div>
</div>

<main id="main-content"></main>
<div id="toast-container"></div>
<div class="modal-overlay" id="modal-overlay"><div class="modal" id="modal-box"></div></div>

<script>
// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SCRIPT_URL = 'YOUR_APPS_SCRIPT_URL_HERE';
const ROOMS = ['A-2-3','A-2-4','A-2-5','A-2-6','A-2-7','A-2-8','A-2-9','A-2-10'];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const S = {
  books: [], rooms: [], inventory: [],
  tab: 'all', search: '', sortField: 'title', sortDir: 'asc',
  mode: 'view',  // 'view' | 'edit' | 'recount'
  configured: SCRIPT_URL !== 'YOUR_APPS_SCRIPT_URL_HERE'
};
// Pending qty edits: { "roomId|bookId": newQty }
const pending = {};

// ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function apiGet() {
  const res = await fetch(`${SCRIPT_URL}?action=getAll`);
  const d = await res.json();
  if (d.error) throw new Error(d.error);
  return d;
}
async function apiPost(payload) {
  const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
  const d = await res.json();
  if (d.error) throw new Error(d.error);
  return d;
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const norm = s => String(s||'').trim().replace(/\s+/g,' ').toLowerCase();
const bKey = (t,a) => norm(t)+'||'+norm(a);
const esc  = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const invQty = (roomId, bookId) => { const r = S.inventory.find(r=>r.room_id===roomId&&r.book_id===bookId); return r ? Number(r.quantity) : 0; };
const totalQty = bookId => S.inventory.filter(r=>r.book_id===bookId).reduce((s,r)=>s+Number(r.quantity),0);
const locations = bookId => S.inventory.filter(r=>r.book_id===bookId&&Number(r.quantity)>0).map(r=>`${r.room_id}: ${r.quantity}`).join(', ') || '‚Äî';
const teacher  = roomId => { const r=S.rooms.find(r=>r.room_id===roomId); return r?r.teacher_name||'':''; };
const genId    = () => Date.now().toString(36)+Math.random().toString(36).slice(2,6);
const now      = () => new Date().toISOString();

function setStatus(type, text) {
  document.getElementById('status-dot').className = 'status-dot '+(type||'');
  document.getElementById('status-text').textContent = text;
}
function updateCounts() {
  const el = document.getElementById('count-all');
  if (el) el.textContent = S.books.length;
  ROOMS.forEach(r => {
    const el = document.getElementById(`count-${r}`);
    if (el) el.textContent = S.inventory.filter(i=>i.room_id===r&&Number(i.quantity)>0).length;
  });
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg, type='default', ms=3000) {
  const icons={success:'‚úì',error:'‚úï',warning:'‚ö†',default:'‚Ñπ'};
  const el=document.createElement('div');
  el.className=`toast ${type}`;
  el.innerHTML=`<span>${icons[type]||'‚Ñπ'}</span><span>${msg}</span>`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(()=>{ el.style.transition='opacity 300ms'; el.style.opacity='0'; setTimeout(()=>el.remove(),300); }, ms);
}

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(html, onOpen) {
  const overlay=document.getElementById('modal-overlay');
  const box=document.getElementById('modal-box');
  box.innerHTML=html;
  overlay.classList.add('visible');
  if (onOpen) onOpen(box);
}
function closeModal() { document.getElementById('modal-overlay').classList.remove('visible'); }
document.getElementById('modal-overlay').addEventListener('click', e=>{ if(e.target===e.currentTarget) closeModal(); });
document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

function confirmDialog(msg, onConfirm, danger=true) {
  openModal(`<div class="modal confirm-modal">
    <div class="modal-header"><h3>Confirm</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
    <div class="confirm-body">${msg}</div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn ${danger?'btn-danger':'btn-primary'}" id="conf-ok">Confirm</button>
    </div></div>`);
  document.getElementById('conf-ok').onclick=()=>{ closeModal(); onConfirm(); };
}

// ‚îÄ‚îÄ LOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadData() {
  if (!S.configured) { setStatus('error','Not configured'); renderView(); return; }
  setStatus('loading','Loading‚Ä¶');
  try {
    const d = await apiGet();
    S.books     = d.books     || [];
    S.rooms     = d.rooms     || [];
    S.inventory = d.inventory || [];
    updateCounts();
    setStatus('',`${S.books.length} books`);
    renderView();
  } catch(err) {
    setStatus('error','Error');
    toast('Failed to load: '+err.message,'error',6000);
    renderView();
  }
}

// ‚îÄ‚îÄ SORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sortBooks(books) {
  return [...books].sort((a,b)=>{
    let va,vb;
    if(S.sortField==='title')  { va=a.title.toLowerCase(); vb=b.title.toLowerCase(); }
    else if(S.sortField==='author') { va=a.author.toLowerCase(); vb=b.author.toLowerCase(); }
    else { va=totalQty(a.book_id); vb=totalQty(b.book_id); }
    return (va<vb?-1:va>vb?1:0)*(S.sortDir==='asc'?1:-1);
  });
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderView() {
  // Save scroll and search value before re-render
  const prevSearch = S.search;
  document.getElementById('main-content').innerHTML =
    S.tab === 'all' ? renderAll() : renderRoom(S.tab);
  bindTabEvents();
  // Restore search input without stealing focus
  const si = document.getElementById('search-input');
  if (si) { si.value = prevSearch; si.addEventListener('input', e=>{ S.search=e.target.value; debounceRender(); }); }
  document.querySelectorAll('th[data-sort]').forEach(th => th.addEventListener('click', ()=>{
    const f=th.dataset.sort;
    if(S.sortField===f) S.sortDir=S.sortDir==='asc'?'desc':'asc'; else { S.sortField=f; S.sortDir='asc'; }
    renderView();
  }));
}

let renderTimer;
function debounceRender() { clearTimeout(renderTimer); renderTimer = setTimeout(renderView, 120); }

function bindTabEvents() {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', ()=>{
    if (S.mode !== 'view') { S.mode='view'; clearPending(); }
    S.tab=btn.dataset.tab; S.search='';
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    renderView();
  }));
}

// ‚îÄ‚îÄ ALL BOOKS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll() {
  const q=S.search.toLowerCase();
  let books=S.books.filter(b=>!q||b.title.toLowerCase().includes(q)||b.author.toLowerCase().includes(q));
  books=sortBooks(books);
  const sf=S.sortField, sd=S.sortDir;
  const si=f=>`<span class="sort-icon">${sf===f?(sd==='asc'?'‚Üë':'‚Üì'):'‚Üï'}</span>`;

  const configBanner = !S.configured ? `<div class="config-banner"><strong>‚öô Setup Required</strong>Set <code>SCRIPT_URL</code> in index.html to your Apps Script URL.</div>` : '';

  const rows = books.length ? books.map(b=>`
    <tr>
      <td class="td-title">${esc(b.title)}</td>
      <td class="td-author">${esc(b.author)}</td>
      <td class="td-qty"><span class="qty-badge">${totalQty(b.book_id)}</span></td>
      <td class="td-locations">${locations(b.book_id)}</td>
      <td><div class="actions-cell">
        <button class="btn btn-ghost" title="Delete from database" onclick="deleteBook('${b.book_id}')">üóë</button>
      </div></td>
    </tr>`).join('') : `<tr><td colspan="5"><div class="empty-state"><h3>No books found</h3><p>${q?'Try a different search.':'Add your first book.'}</p></div></td></tr>`;

  return `${configBanner}
    <div class="toolbar">
      <div class="search-wrap">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input class="search-input" id="search-input" type="search" placeholder="Search title or author‚Ä¶" autocomplete="off">
      </div>
      <button class="btn btn-primary" onclick="openAddToCatalogModal()">Ôºã New Book to Catalog</button>
      <button class="btn btn-secondary" onclick="openImportModal()">‚¨Ü Import CSV</button>
      <button class="btn btn-secondary" onclick="exportCSV()">‚¨á Export CSV</button>
    </div>
    <div class="table-wrap"><table>
      <thead><tr>
        <th class="sortable ${sf==='title'?'sorted':''}" data-sort="title">Title ${si('title')}</th>
        <th class="sortable ${sf==='author'?'sorted':''}" data-sort="author">Author ${si('author')}</th>
        <th class="sortable ${sf==='qty'?'sorted':''}" data-sort="qty" style="text-align:center">Total Qty ${si('qty')}</th>
        <th>Locations</th><th></th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table></div>
    <p style="margin-top:0.75rem;font-size:0.78rem;color:var(--muted);text-align:right">${books.length} title${books.length!==1?'s':''}</p>`;
}

// ‚îÄ‚îÄ ROOM VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRoom(roomId) {
  const q=S.search.toLowerCase();
  const t=teacher(roomId);
  const mode=S.mode; // 'view' | 'edit' | 'recount'

  let books = S.books.filter(b=>{
    const qty=invQty(roomId,b.book_id);
    if(qty<=0) return false;
    return !q || b.title.toLowerCase().includes(q) || b.author.toLowerCase().includes(q);
  });
  books=sortBooks(books);

  const teacherRow = mode==='edit' ? `
    <div class="teacher-edit-wrap">
      <input class="inline-input" id="teacher-input" type="text" value="${esc(t)}" placeholder="Teacher name‚Ä¶">
      <button class="btn btn-primary" onclick="saveTeacher('${roomId}')">Save</button>
    </div>` : `<div class="teacher-display">${t?'üë§ '+esc(t):'<em style="color:var(--muted)">No teacher assigned</em>'}</div>`;

  // Mode indicator pill
  const modePill = mode==='edit' ? `<span class="mode-indicator">‚úè Edit Mode</span>` :
                   mode==='recount' ? `<span class="mode-indicator recount">üìã Recount Mode</span>` : '';

  // Action buttons
  const hasPending = Object.keys(pending).length > 0;
  const actionBtns = mode==='view' ? `
      <button class="btn btn-gold" onclick="setMode('edit')">‚úè Edit Room</button>
      <button class="btn btn-teal" onclick="openRecountModal('${roomId}')">üìã Recount Room</button>
    ` : mode==='edit' ? `
      ${hasPending?`<button class="btn btn-primary" id="save-qty-btn" onclick="saveAllQty()">üíæ Save Changes</button>`:''}
      <button class="btn btn-primary" onclick="openAddToRoomModal('${roomId}')">Ôºã Add Books Here</button>
      <button class="btn btn-gold active" onclick="exitEdit()">‚úì Done</button>
    ` : `<button class="btn btn-teal active" onclick="setMode('view')">‚úì Done</button>`;

  // Table rows
  const rows = books.length ? books.map(b=>{
    const qty=invQty(roomId,b.book_id);
    const key=`${roomId}|${b.book_id}`;
    const pv=pending[key]!==undefined?pending[key]:qty;

    let qtyCell, actionCell='';
    if(mode==='edit') {
      const dirty=pending[key]!==undefined&&pending[key]!==qty;
      qtyCell=`<div class="qty-control">
        <button class="qty-btn" onclick="adjQty('${roomId}','${b.book_id}',-1)">‚àí</button>
        <input class="qty-input${dirty?' dirty':''}" type="number" min="0" value="${pv}" data-key="${key}"
          oninput="onQtyInput(this,'${roomId}','${b.book_id}')">
        <button class="qty-btn" onclick="adjQty('${roomId}','${b.book_id}',1)">Ôºã</button>
      </div>`;
      actionCell=`<td><div class="actions-cell">
        <button class="btn btn-secondary" style="font-size:0.78rem" onclick="openTransferModal('${roomId}','${b.book_id}')">‚áÑ Transfer</button>
        <button class="btn btn-ghost" title="Remove from this room" onclick="removeFromRoom('${roomId}','${b.book_id}')">‚úï</button>
      </div></td>`;
    } else {
      qtyCell=`<span class="qty-badge">${qty}</span>`;
    }

    return `<tr>
      <td class="td-title">${esc(b.title)}</td>
      <td class="td-author">${esc(b.author)}</td>
      <td class="td-qty">${qtyCell}</td>
      ${actionCell}
    </tr>`;
  }).join('') : `<tr><td colspan="${mode==='edit'?4:3}">
    <div class="empty-state">
      <h3>No books in this room</h3>
      <p>${q?'Try a different search.':'Use "Add Books Here" to add books to this room.'}</p>
    </div></td></tr>`;

  const colSpan = mode==='edit' ? 4 : 3;

  return `
    <div class="room-header">
      <div class="room-header-left">
        <h2>Room ${roomId} ${modePill}</h2>
        ${teacherRow}
      </div>
      <div class="room-actions">${actionBtns}</div>
    </div>
    <div class="toolbar">
      <div class="search-wrap">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input class="search-input" id="search-input" type="search" placeholder="Search books in this room‚Ä¶" autocomplete="off">
      </div>
    </div>
    <div class="table-wrap"><table>
      <thead><tr>
        <th class="sortable" data-sort="title">Title</th>
        <th class="sortable" data-sort="author">Author</th>
        <th style="text-align:center">${mode==='edit'?'Adjust Qty':'Qty'}</th>
        ${mode==='edit'?'<th></th>':''}
      </tr></thead>
      <tbody>${rows}</tbody>
    </table></div>
    <p style="margin-top:0.75rem;font-size:0.78rem;color:var(--muted);text-align:right">${books.length} title${books.length!==1?'s':''} in Room ${roomId}</p>`;
}

// ‚îÄ‚îÄ MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setMode(m) { S.mode=m; renderView(); }
function exitEdit() {
  if(Object.keys(pending).length>0) {
    confirmDialog('You have unsaved changes. Discard them?', ()=>{ clearPending(); S.mode='view'; renderView(); });
    return;
  }
  S.mode='view'; renderView();
}
function clearPending() { Object.keys(pending).forEach(k=>delete pending[k]); }

// ‚îÄ‚îÄ QTY EDIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function adjQty(roomId, bookId, delta) {
  const key=`${roomId}|${bookId}`;
  const cur=pending[key]!==undefined?pending[key]:invQty(roomId,bookId);
  pending[key]=Math.max(0,cur+delta);
  const inp=document.querySelector(`.qty-input[data-key="${key}"]`);
  if(inp){ inp.value=pending[key]; inp.classList.toggle('dirty',pending[key]!==invQty(roomId,bookId)); }
  updateSaveBtn();
}
function onQtyInput(inp, roomId, bookId) {
  const key=`${roomId}|${bookId}`;
  pending[key]=Math.max(0,parseInt(inp.value)||0);
  inp.value=pending[key];
  inp.classList.toggle('dirty',pending[key]!==invQty(roomId,bookId));
  updateSaveBtn();
}
function updateSaveBtn() {
  const btn=document.getElementById('save-qty-btn');
  const hasPending=Object.keys(pending).length>0;
  if(!btn && hasPending) {
    const actions=document.querySelector('.room-actions');
    if(actions){ const b=document.createElement('button'); b.className='btn btn-primary'; b.id='save-qty-btn'; b.setAttribute('onclick','saveAllQty()'); b.textContent='üíæ Save Changes'; actions.insertBefore(b,actions.firstChild); }
  } else if(btn && !hasPending) btn.remove();
}

async function saveAllQty() {
  const updates=Object.entries(pending).map(([key,qty])=>{ const [r,b]=key.split('|'); return {room_id:r,book_id:b,quantity:qty}; });
  if(!updates.length) return;
  setStatus('loading','Saving‚Ä¶');
  try {
    await apiPost({action:'updateInventoryBatch',updates});
    updates.forEach(u=>{
      const inv=S.inventory.find(r=>r.room_id===u.room_id&&r.book_id===u.book_id);
      if(inv) inv.quantity=u.quantity;
      else S.inventory.push({room_id:u.room_id,book_id:u.book_id,quantity:u.quantity,updated_at:now()});
    });
    clearPending(); updateCounts(); setStatus('',`${S.books.length} books`);
    toast(`${updates.length} change${updates.length!==1?'s':''} saved`,'success');
    renderView();
  } catch(err) { setStatus('error','Error'); toast('Save failed: '+err.message,'error'); }
}

// ‚îÄ‚îÄ RECOUNT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openRecountModal(roomId) {
  // Show ALL catalog books so user can enter counts for everything
  const allBooks = sortBooks(S.books);

  const rows = allBooks.map(b=>{
    const current = invQty(roomId, b.book_id);
    return `<tr>
      <td>${esc(b.title)}</td>
      <td style="color:var(--muted);font-size:0.8rem">${esc(b.author)}</td>
      <td style="text-align:center">
        <input class="recount-input" type="number" min="0" value="${current}"
          data-book-id="${b.book_id}" data-prev="${current}">
      </td>
      <td class="recount-prev">(was ${current})</td>
    </tr>`;
  }).join('');

  openModal(`<div class="modal tall wide">
    <div class="modal-header">
      <div>
        <h3>üìã Recount Room ${roomId}</h3>
        <div class="modal-subtitle">Enter the actual number of books physically in this room right now.</div>
      </div>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="recount-note">
        ‚úî This sets the definitive count ‚Äî whatever you type replaces what was recorded before.
        Leave a field at 0 if the book is not in this room.
      </div>
      <div style="max-height:400px;overflow-y:auto;">
        <table class="recount-table">
          <thead><tr><th>Title</th><th>Author</th><th style="text-align:center">Count</th><th></th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-teal" onclick="submitRecount('${roomId}')">üíæ Save Recount</button>
    </div>
  </div>`);
}

async function submitRecount(roomId) {
  const inputs = document.querySelectorAll('.recount-input');
  const updates = [];
  inputs.forEach(inp=>{
    const bookId=inp.dataset.bookId;
    const qty=Math.max(0,parseInt(inp.value)||0);
    const prev=parseInt(inp.dataset.prev)||0;
    if(qty!==prev) updates.push({room_id:roomId,book_id:bookId,quantity:qty});
  });
  if(!updates.length){ toast('No changes to save','warning'); return; }
  setStatus('loading','Saving recount‚Ä¶');
  try {
    await apiPost({action:'updateInventoryBatch',updates});
    updates.forEach(u=>{
      const inv=S.inventory.find(r=>r.room_id===u.room_id&&r.book_id===u.book_id);
      if(inv) inv.quantity=u.quantity;
      else S.inventory.push({room_id:u.room_id,book_id:u.book_id,quantity:u.quantity,updated_at:now()});
    });
    updateCounts(); setStatus('',`${S.books.length} books`);
    closeModal(); toast(`Recount saved ‚Äî ${updates.length} title${updates.length!==1?'s':''} updated`,'success');
    renderView();
  } catch(err) { setStatus('error','Error'); toast('Recount failed: '+err.message,'error'); }
}

// ‚îÄ‚îÄ TEACHER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveTeacher(roomId) {
  const name=document.getElementById('teacher-input').value.trim();
  try {
    await apiPost({action:'updateTeacher',room_id:roomId,teacher_name:name});
    const r=S.rooms.find(r=>r.room_id===roomId);
    if(r) r.teacher_name=name; else S.rooms.push({room_id:roomId,teacher_name:name,updated_at:now()});
    toast('Teacher name saved','success'); renderView();
  } catch(err){ toast('Failed: '+err.message,'error'); }
}

// ‚îÄ‚îÄ REMOVE FROM ROOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function removeFromRoom(roomId, bookId) {
  const b=S.books.find(b=>b.book_id===bookId);
  confirmDialog(`Remove <strong>${esc(b?.title)}</strong> from Room ${roomId}?<br><small>Sets quantity to 0. The book stays in the catalog.</small>`, async ()=>{
    try {
      await apiPost({action:'updateInventory',room_id:roomId,book_id:bookId,quantity:0});
      const inv=S.inventory.find(r=>r.room_id===roomId&&r.book_id===bookId);
      if(inv) inv.quantity=0;
      updateCounts(); toast('Removed from room','success'); renderView();
    } catch(err){ toast('Failed: '+err.message,'error'); }
  });
}

// ‚îÄ‚îÄ DELETE BOOK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function deleteBook(bookId) {
  const b=S.books.find(b=>b.book_id===bookId);
  confirmDialog(`<strong>Permanently delete from database?</strong><br><br>"${esc(b?.title)}" by ${esc(b?.author)}<br><br>Removes the book and ALL inventory records across every room.`, async ()=>{
    try {
      await apiPost({action:'deleteBook',book_id:bookId});
      S.books=S.books.filter(b=>b.book_id!==bookId);
      S.inventory=S.inventory.filter(r=>r.book_id!==bookId);
      updateCounts(); toast('Book deleted from database','success'); renderView();
    } catch(err){ toast('Delete failed: '+err.message,'error'); }
  });
}

// ‚îÄ‚îÄ ADD TO CATALOG (All Books tab) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openAddToCatalogModal() {
  openModal(`<div class="modal">
    <div class="modal-header">
      <div><h3>Add New Book to Catalog</h3>
        <div class="modal-subtitle">Creates the book record ‚Äî does not assign it to a room yet.</div>
      </div>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label>Title *</label>
        <input class="form-input" id="ac-title" type="text" placeholder="Book title‚Ä¶">
        <div id="ac-warn"></div>
      </div>
      <div class="form-group"><label>Author *</label>
        <input class="form-input" id="ac-author" type="text" placeholder="Author name‚Ä¶"></div>
      <hr class="divider">
      <div class="form-group"><label>Also add to a room now? (optional)</label>
        <select class="form-select" id="ac-room">
          <option value="">‚Äî Catalog only (no room) ‚Äî</option>
          ${ROOMS.map(r=>`<option value="${r}">${r}</option>`).join('')}
        </select>
      </div>
      <div class="form-group" id="ac-qty-wrap" style="display:none">
        <label>Quantity for that room</label>
        <input class="form-input" id="ac-qty" type="number" min="1" value="1">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="submitAddToCatalog()">Add to Catalog</button>
    </div>
  </div>`, box=>{
    box.querySelector('#ac-room').addEventListener('change',e=>{
      box.querySelector('#ac-qty-wrap').style.display=e.target.value?'block':'none';
    });
    box.querySelector('#ac-title').addEventListener('input',e=>checkDupe(e.target.value,box.querySelector('#ac-author').value,'ac-warn'));
    box.querySelector('#ac-title').focus();
  });
}

function checkDupe(title,author,warnId) {
  const w=document.getElementById(warnId); if(!w) return;
  if(title!==title.trim()){ w.innerHTML='<div class="form-warning">‚ö† Leading/trailing spaces detected.</div>'; return; }
  const ex=S.books.find(b=>bKey(b.title,b.author)===bKey(title,author));
  w.innerHTML=ex?'<div class="form-warning">‚ö† This title/author already exists in the catalog.</div>':'';
}

async function submitAddToCatalog() {
  const title=document.getElementById('ac-title').value;
  const author=document.getElementById('ac-author').value;
  const room=document.getElementById('ac-room').value;
  const qty=parseInt(document.getElementById('ac-qty')?.value)||1;
  if(!title.trim()){ toast('Title is required','warning'); return; }
  if(!author.trim()){ toast('Author is required','warning'); return; }
  const ex=S.books.find(b=>bKey(b.title,b.author)===bKey(title,author));
  if(ex){ toast('This book already exists in the catalog','warning'); return; }
  await doAddBook(title,author,room||null,qty);
}

// ‚îÄ‚îÄ ADD BOOKS TO ROOM (room tab) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let acSel=null, acMode='search';

function openAddToRoomModal(roomId) {
  openModal(`<div class="modal">
    <div class="modal-header">
      <div><h3>Add Books to Room ${roomId}</h3>
        <div class="modal-subtitle">Search the catalog or create a brand-new book.</div>
      </div>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Search catalog</label>
        <div class="autocomplete-wrap">
          <input class="form-input" id="atr-q" type="text" placeholder="Type title or author‚Ä¶" autocomplete="off">
          <div class="autocomplete-list" id="atr-list"></div>
        </div>
        <div class="form-hint">Type at least 2 characters to search existing books</div>
      </div>
      <div id="atr-existing" style="display:none">
        <div class="form-info">üìö Adding copies of an existing book to Room ${roomId}</div>
        <div class="form-group" style="margin-top:0.75rem"><label>Title</label><input class="form-input readonly" id="atr-title" readonly></div>
        <div class="form-group"><label>Author</label><input class="form-input readonly" id="atr-author" readonly></div>
      </div>
      <div id="atr-new" style="display:none">
        <div class="form-info">‚ú® Creating a brand-new book and adding it to Room ${roomId}</div>
        <div class="form-group" style="margin-top:0.75rem"><label>Title *</label>
          <input class="form-input" id="atr-new-title" type="text" placeholder="Title‚Ä¶">
          <div id="atr-warn"></div>
        </div>
        <div class="form-group"><label>Author *</label><input class="form-input" id="atr-new-author" type="text" placeholder="Author‚Ä¶"></div>
      </div>
      <div class="form-group" id="atr-qty-wrap" style="display:none">
        <label>Number of copies to add to Room ${roomId}</label>
        <input class="form-input" id="atr-qty" type="number" min="1" value="1">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="submitAddToRoom('${roomId}')">Add to Room ${roomId}</button>
    </div>
  </div>`, box=>{
    acSel=null; acMode='search';
    const inp=box.querySelector('#atr-q');
    inp.addEventListener('input',()=>renderAC(inp.value,box));
    inp.addEventListener('keydown',e=>acKeyNav(e,box));
    inp.focus();
  });
}

function renderAC(q, box) {
  acSel=null;
  ['#atr-existing','#atr-new','#atr-qty-wrap'].forEach(s=>box.querySelector(s).style.display='none');
  const list=box.querySelector('#atr-list');
  if(q.length<2){ list.classList.remove('open'); return; }
  const ql=q.toLowerCase();
  const matches=S.books.filter(b=>b.title.toLowerCase().includes(ql)||b.author.toLowerCase().includes(ql)).slice(0,10);
  list.innerHTML=matches.map((b,i)=>`
    <div class="autocomplete-item" data-idx="${i}" onmousedown="acPick('${b.book_id}',event,document.querySelector('.modal'))">
      <div class="item-title">${esc(b.title)}</div>
      <div class="item-author">${esc(b.author)}</div>
    </div>`).join('')+
    `<div class="autocomplete-item create-new" onmousedown="acNew('${esc(q)}',event,document.querySelector('.modal'))">
      ‚ú® Create "${esc(q)}" as a new book
    </div>`;
  list.classList.add('open');
}

function acPick(bookId, e, box) {
  e.preventDefault();
  const b=S.books.find(b=>b.book_id===bookId); if(!b) return;
  acSel=b; acMode='existing';
  box.querySelector('#atr-q').value=`${b.title} ‚Äî ${b.author}`;
  box.querySelector('#atr-list').classList.remove('open');
  box.querySelector('#atr-title').value=b.title;
  box.querySelector('#atr-author').value=b.author;
  box.querySelector('#atr-existing').style.display='block';
  box.querySelector('#atr-new').style.display='none';
  box.querySelector('#atr-qty-wrap').style.display='block';
}

function acNew(q, e, box) {
  e.preventDefault();
  acSel=null; acMode='new';
  box.querySelector('#atr-list').classList.remove('open');
  box.querySelector('#atr-existing').style.display='none';
  box.querySelector('#atr-new').style.display='block';
  box.querySelector('#atr-qty-wrap').style.display='block';
  const ti=box.querySelector('#atr-new-title');
  ti.value=q;
  ti.addEventListener('input',ev=>checkDupe(ev.target.value,box.querySelector('#atr-new-author').value,'atr-warn'));
}

function acKeyNav(e, box) {
  const items=box.querySelectorAll('.autocomplete-item');
  let hi=parseInt(box.dataset.hi||'-1');
  if(e.key==='ArrowDown'){ hi=Math.min(hi+1,items.length-1); }
  else if(e.key==='ArrowUp'){ hi=Math.max(hi-1,0); }
  else if(e.key==='Enter'&&hi>=0){ items[hi].dispatchEvent(new MouseEvent('mousedown')); e.preventDefault(); return; }
  box.dataset.hi=hi;
  items.forEach((it,i)=>it.classList.toggle('highlighted',i===hi));
}

async function submitAddToRoom(roomId) {
  const qty=parseInt(document.getElementById('atr-qty')?.value)||0;
  if(qty<=0){ toast('Enter a quantity','warning'); return; }

  if(acMode==='existing'&&acSel) {
    const newQty=invQty(roomId,acSel.book_id)+qty;
    try {
      await apiPost({action:'updateInventory',room_id:roomId,book_id:acSel.book_id,quantity:newQty});
      const inv=S.inventory.find(r=>r.room_id===roomId&&r.book_id===acSel.book_id);
      if(inv) inv.quantity=newQty; else S.inventory.push({room_id:roomId,book_id:acSel.book_id,quantity:newQty,updated_at:now()});
      updateCounts(); closeModal();
      toast(`Added ${qty} cop${qty>1?'ies':'y'} of "${acSel.title}" to Room ${roomId}`,'success');
      renderView();
    } catch(err){ toast('Failed: '+err.message,'error'); }
  } else if(acMode==='new') {
    const title=document.getElementById('atr-new-title').value.trim();
    const author=document.getElementById('atr-new-author').value.trim();
    if(!title){ toast('Title required','warning'); return; }
    if(!author){ toast('Author required','warning'); return; }
    const ex=S.books.find(b=>bKey(b.title,b.author)===bKey(title,author));
    if(ex){
      confirmDialog(`"${esc(title)}" already exists. Add ${qty} cop${qty>1?'ies':'y'} to Room ${roomId} using that existing record?`, async ()=>{
        const nq=invQty(roomId,ex.book_id)+qty;
        await apiPost({action:'updateInventory',room_id:roomId,book_id:ex.book_id,quantity:nq});
        const inv=S.inventory.find(r=>r.room_id===roomId&&r.book_id===ex.book_id);
        if(inv) inv.quantity=nq; else S.inventory.push({room_id:roomId,book_id:ex.book_id,quantity:nq,updated_at:now()});
        updateCounts(); closeModal(); toast('Added to room','success'); renderView();
      },false); return;
    }
    await doAddBook(title,author,roomId,qty);
  } else {
    toast('Search for a book or create a new one','warning');
  }
}

async function doAddBook(title, author, roomId, qty) {
  try {
    const book_id=genId();
    const d=await apiPost({action:'addBook',book_id,title:title.trim(),author:author.trim(),room_id:roomId||null,quantity:qty});
    const bid=d.book_id||book_id;
    if(!S.books.find(b=>b.book_id===bid)) S.books.push({book_id:bid,title:title.trim(),author:author.trim(),created_at:now(),updated_at:now()});
    if(roomId&&qty>0){
      const inv=S.inventory.find(r=>r.room_id===roomId&&r.book_id===bid);
      if(inv) inv.quantity=Number(inv.quantity)+qty;
      else S.inventory.push({room_id:roomId,book_id:bid,quantity:qty,updated_at:now()});
    }
    updateCounts(); closeModal();
    toast(`"${title}" added${roomId?` to Room ${roomId}`:'to catalog'}`,'success');
    renderView();
  } catch(err){ toast('Failed: '+err.message,'error'); }
}

// ‚îÄ‚îÄ TRANSFER COPIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openTransferModal(fromRoom, bookId) {
  const b=S.books.find(b=>b.book_id===bookId);
  const avail=invQty(fromRoom,bookId);
  const others=ROOMS.filter(r=>r!==fromRoom);

  openModal(`<div class="modal">
    <div class="modal-header">
      <div><h3>‚áÑ Transfer Copies Between Rooms</h3>
        <div class="modal-subtitle">Move physical copies from one room to another.</div>
      </div>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label>Book</label>
        <input class="form-input readonly" type="text" value="${esc(b?.title)} ‚Äî ${esc(b?.author)}" readonly>
      </div>
      <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:0.75rem;align-items:end;margin-bottom:1rem">
        <div>
          <label style="display:block;font-size:0.8rem;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;color:var(--muted);margin-bottom:0.35rem">From Room</label>
          <input class="form-input readonly" type="text" value="${fromRoom} (${avail} available)" readonly>
        </div>
        <div style="padding-bottom:0.6rem;font-size:1.2rem;color:var(--muted)">‚Üí</div>
        <div>
          <label style="display:block;font-size:0.8rem;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;color:var(--muted);margin-bottom:0.35rem">To Room</label>
          <select class="form-select" id="tr-to">${others.map(r=>`<option value="${r}">${r}</option>`).join('')}</select>
        </div>
      </div>
      <div class="form-group"><label>How many copies to transfer?</label>
        <input class="form-input" id="tr-qty" type="number" min="1" max="${avail}" value="1">
        <div class="form-hint">Max available in ${fromRoom}: ${avail}</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="submitTransfer('${fromRoom}','${bookId}',${avail})">‚áÑ Transfer</button>
    </div>
  </div>`);
}

async function submitTransfer(fromRoom, bookId, avail) {
  const toRoom=document.getElementById('tr-to').value;
  const qty=parseInt(document.getElementById('tr-qty').value)||0;
  if(qty<=0){ toast('Enter a quantity','warning'); return; }
  if(qty>avail){ toast(`Only ${avail} available in ${fromRoom}`,'warning'); return; }
  try {
    await apiPost({action:'moveInventory',from_room:fromRoom,to_room:toRoom,book_id:bookId,quantity:qty});
    const from=S.inventory.find(r=>r.room_id===fromRoom&&r.book_id===bookId);
    if(from) from.quantity=Number(from.quantity)-qty;
    const to=S.inventory.find(r=>r.room_id===toRoom&&r.book_id===bookId);
    if(to) to.quantity=Number(to.quantity)+qty;
    else S.inventory.push({room_id:toRoom,book_id:bookId,quantity:qty,updated_at:now()});
    updateCounts(); closeModal();
    const b=S.books.find(b=>b.book_id===bookId);
    toast(`Transferred ${qty} cop${qty>1?'ies':'y'} of "${b?.title}" from ${fromRoom} ‚Üí ${toRoom}`,'success');
    renderView();
  } catch(err){ toast('Transfer failed: '+err.message,'error'); }
}

// ‚îÄ‚îÄ CSV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportCSV() {
  const lines=['book_id,title,author,'+ROOMS.join(',')];
  S.books.forEach(b=>{ lines.push([b.book_id,q(b.title),q(b.author),...ROOMS.map(r=>invQty(r,b.book_id))].join(',')); });
  lines.push('','# Teachers','room_id,teacher_name');
  S.rooms.forEach(r=>{ if(r.teacher_name) lines.push(`${r.room_id},${q(r.teacher_name)}`); });
  const blob=new Blob([lines.join('\n')],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`asd-library-${new Date().toISOString().slice(0,10)}.csv`; a.click();
  URL.revokeObjectURL(url); toast('CSV exported','success');
}
function q(s){ return (String(s).includes(',')||String(s).includes('"'))?`"${String(s).replace(/"/g,'""')}"`:s; }

function openImportModal() {
  let importData=null;
  openModal(`<div class="modal wide">
    <div class="modal-header"><h3>Import CSV</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
    <div class="modal-body">
      <p class="form-hint" style="margin-bottom:0.75rem">Expected header: <code>book_id, title, author, A-2-3, A-2-4, ‚Ä¶</code></p>
      <div class="form-group"><label>Choose file</label><input type="file" id="imp-file" accept=".csv" style="font-size:0.85rem"></div>
      <div id="imp-preview"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="imp-commit" disabled onclick="doImport()">Import</button>
    </div>
  </div>`, box=>{
    box.querySelector('#imp-file').addEventListener('change',e=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader(); r.onload=ev=>{ importData=parseCSV(ev.target.result); window._importData=importData; showPreview(importData); }; r.readAsText(f);
    });
  });
}

function parseCSV(text) {
  const lines=text.split('\n').map(l=>l.trim()).filter(l=>l&&!l.startsWith('#'));
  if(!lines.length) return {error:'Empty file'};
  const hdr=csvSplit(lines[0]).map(h=>h.trim().toLowerCase());
  const ti=hdr.indexOf('title'), ai=hdr.indexOf('author'), bi=hdr.indexOf('book_id');
  if(ti<0||ai<0) return {error:'Missing title or author column'};
  const rmap={}; ROOMS.forEach(r=>{const i=hdr.indexOf(r.toLowerCase());if(i>=0)rmap[r]=i;});
  const books=[],errors=[];
  for(let i=1;i<lines.length;i++){
    const c=csvSplit(lines[i]);
    const title=(c[ti]||'').trim(), author=(c[ai]||'').trim();
    if(!title||!author){errors.push(`Row ${i+1}: missing title or author`);continue;}
    const book_id=(bi>=0?c[bi]:'')||genId();
    const inventory={};
    Object.entries(rmap).forEach(([r,idx])=>{const v=parseInt(c[idx])||0;if(v>0)inventory[r]=v;});
    books.push({book_id,title,author,inventory});
  }
  return {books,errors};
}
function csvSplit(line){const r=[];let c='',inQ=false;for(let i=0;i<line.length;i++){const ch=line[i];if(ch==='"'){if(inQ&&line[i+1]==='"'){c+='"';i++;}else inQ=!inQ;}else if(ch===','&&!inQ){r.push(c);c='';}else c+=ch;}r.push(c);return r;}

function showPreview(data){
  const el=document.getElementById('imp-preview'),btn=document.getElementById('imp-commit');
  if(data.error){el.innerHTML=`<div class="form-warning">‚úï ${data.error}</div>`;btn.disabled=true;return;}
  const dupes=data.books.filter(b=>S.books.some(ex=>bKey(ex.title,ex.author)===bKey(b.title,b.author)));
  el.innerHTML=`<div class="import-stats">üìö ${data.books.length} books &nbsp;|&nbsp; ${dupes.length} duplicate${dupes.length!==1?'s':''} (quantities will update) &nbsp;|&nbsp; ${data.errors.length} error${data.errors.length!==1?'s':''}</div>
    ${data.errors.map(e=>`<div class="csv-error-item">‚ö† ${e}</div>`).join('')}
    <div class="csv-preview">${data.books.slice(0,10).map(b=>`${b.title} ‚Äî ${b.author}`).join('\n')}${data.books.length>10?`\n‚Ä¶and ${data.books.length-10} more`:''}</div>`;
  btn.disabled=data.books.length===0;
}

async function doImport(){
  const data=window._importData; if(!data?.books?.length) return;
  try {
    const res=await apiPost({action:'importData',data:data.books});
    S.books=res.books||S.books; S.inventory=res.inventory||S.inventory;
    updateCounts(); closeModal(); toast(`Imported ${data.books.length} books`,'success'); renderView();
  } catch(err){ toast('Import failed: '+err.message,'error'); }
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', ()=>{ renderView(); loadData(); });
</script>
</body>
</html>
